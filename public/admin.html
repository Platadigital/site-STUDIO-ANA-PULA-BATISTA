<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração | Studio Ana Paula Batista</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f7fafc;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .progress-bar {
            height: 8px;
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-inner {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }
        .media-preview {
            max-height: 250px;
            width: 100%;
            object-fit: cover;
            border-radius: 0.5rem;
            background-color: #f3f4f6;
        }
        .file-input-label {
            cursor: pointer;
            padding: 0.75rem 1.5rem;
            background-color: #1f2937;
            color: white;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .file-input-label:hover {
            background-color: #374151;
        }
        .status-message {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            min-height: 1.25rem;
        }
        .status-success { color: #16a34a; }
        .status-error { color: #dc2626; }
        .status-uploading { color: #2563eb; }

        /* Estilos para Accordion */
        .accordion-header {
            cursor: pointer;
            width: 100%;
            text-align: left;
            border: none;
            outline: none;
            transition: background-color 0.3s ease;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-4">Acesso Restrito</h2>
            <p class="text-gray-600 mb-6">Faça login para gerenciar o conteúdo.</p>
            <div class="space-y-4">
                 <input type="email" id="email-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="E-mail">
                <input type="password" id="password-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Senha">
            </div>
            <button id="login-button" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition-colors mt-6">Entrar</button>
            <p id="login-error" class="text-red-500 text-sm mt-4 h-4"></p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl text-center w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Confirmar Exclusão</h2>
            <p id="confirm-modal-text" class="text-gray-600 mb-6">Tem certeza de que deseja excluir esta mídia?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">Excluir</button>
            </div>
        </div>
    </div>


    <!-- Main Content (Hidden by default) -->
    <div id="main-content" class="hidden">
        <header class="bg-white shadow-md sticky top-0 z-40">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold tracking-wider">PAINEL DE ADMINISTRAÇÃO</h1>
                <button id="logout-button" class="text-sm text-red-600 hover:underline flex items-center space-x-2">
                    <i data-feather="log-out" class="w-4 h-4"></i>
                    <span>Sair</span>
                </button>
            </div>
        </header>

        <main class="container mx-auto px-6 py-12">
            <p class="mb-8 text-gray-600">Atualize as mídias do seu site. Clique em uma seção para expandir e ver as opções.</p>
            
            <div id="admin-sections" class="space-y-4">
                <!-- Accordion sections will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Cole aqui a configuração do seu projeto Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBy92mP9erKG-fpjDcAlynaARse5TlYBmw",
            authDomain: "ana-paula-studio.firebaseapp.com",
            projectId: "ana-paula-studio",
            storageBucket: "ana-paula-studio.appspot.com",
            messagingSenderId: "1083569634551",
            appId: "1:1083569634551:web:8a433a76389753e6831d38"
        };

        // Inicialização do Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const auth = getAuth(app);

        // Estrutura de dados das mídias, agora com seções
        const mediaStructure = [
            { id: 'heroVideo', title: 'Vídeo Principal', type: 'video', section: 'hero', sectionTitle: 'Página Principal (Hero)' },
            { id: 'aboutBanner', title: 'Banner "Sobre Nós"', type: 'image', section: 'sobre', sectionTitle: 'Seção Sobre' },
            { id: 'servicesImage', title: 'Imagem de Serviços', type: 'image', section: 'servicos', sectionTitle: 'Seção Serviços' },
            { id: 'product1', title: 'Produto Loja 1', type: 'image', section: 'loja', sectionTitle: 'Seção Loja' },
            { id: 'product2', title: 'Produto Loja 2', type: 'image', section: 'loja', sectionTitle: 'Seção Loja' },
            { id: 'product3', title: 'Produto Loja 3', type: 'image', section: 'loja', sectionTitle: 'Seção Loja' },
            { id: 'artist1', title: 'Artista 1', type: 'image', section: 'artistas', sectionTitle: 'Seção Artistas' },
            { id: 'artist2', title: 'Artista 2', type: 'image', section: 'artistas', sectionTitle: 'Seção Artistas' },
            { id: 'artist3', title: 'Artista 3', type: 'image', section: 'artistas', sectionTitle: 'Seção Artistas' },
            { id: 'inspiration1', title: 'Inspiração 1', type: 'image', section: 'inspiracoes', sectionTitle: 'Seção Inspirações' },
            { id: 'inspiration2', title: 'Inspiração 2', type: 'image', section: 'inspiracoes', sectionTitle: 'Seção Inspirações' },
            { id: 'inspiration3', title: 'Inspiração 3', type: 'image', section: 'inspiracoes', sectionTitle: 'Seção Inspirações' },
            { id: 'inspiration4', title: 'Inspiração 4', type: 'image', section: 'inspiracoes', sectionTitle: 'Seção Inspirações' },
            { id: 'inspiration5', title: 'Inspiração 5', type: 'image', section: 'inspiracoes', sectionTitle: 'Seção Inspirações' },
            { id: 'momentsVideo1', title: 'Momentos Vídeo 1', type: 'video', section: 'momentos', sectionTitle: 'Seção Momentos (Vídeos)' },
            { id: 'momentsVideo2', title: 'Momentos Vídeo 2', type: 'video', section: 'momentos', sectionTitle: 'Seção Momentos (Vídeos)' },
            { id: 'momentsVideo3', title: 'Momentos Vídeo 3', type: 'video', section: 'momentos', sectionTitle: 'Seção Momentos (Vídeos)' },
            { id: 'momentsVideo4', title: 'Momentos Vídeo 4', type: 'video', section: 'momentos', sectionTitle: 'Seção Momentos (Vídeos)' },
            { id: 'momentsVideo5', title: 'Momentos Vídeo 5', type: 'video', section: 'momentos', sectionTitle: 'Seção Momentos (Vídeos)' },
            { id: 'momentsVideo6', title: 'Momentos Vídeo 6', type: 'video', section: 'momentos', sectionTitle: 'Seção Momentos (Vídeos)' },
            { id: 'bannerFinal', title: 'Banner Final', type: 'image', section: 'bannerFinal', sectionTitle: 'Banner Final' },
        ];

        const contentDocRef = doc(db, "siteContent", "homepage");

        // --- Lógica de Autenticação e UI ---
        const loginOverlay = document.getElementById('login-overlay');
        const mainContent = document.getElementById('main-content');
        const loginButton = document.getElementById('login-button');
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        const logoutButton = document.getElementById('logout-button');
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginOverlay.classList.add('hidden');
                mainContent.classList.remove('hidden');
                initAdminPanel();
            } else {
                loginOverlay.classList.remove('hidden');
                mainContent.classList.add('hidden');
            }
            feather.replace();
        });

        loginButton.addEventListener('click', async () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            loginError.textContent = '';
            if (!email || !password) {
                loginError.textContent = 'Por favor, preencha e-mail e senha.';
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                loginError.textContent = 'E-mail ou senha inválidos.';
            }
        });
        
        [emailInput, passwordInput].forEach(input => {
            input.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') loginButton.click();
            });
        });

        logoutButton.addEventListener('click', () => signOut(auth));

        // --- Lógica do Painel de Administração ---

        function createMediaCard(media, container) {
            const card = document.createElement('div');
            card.className = 'card p-6 flex flex-col';
            card.innerHTML = `
                <h3 class="text-lg font-bold mb-4">${media.title}</h3>
                <div id="preview-container-${media.id}" class="mb-4">
                    <div class="media-preview flex items-center justify-center text-gray-500">Carregando...</div>
                </div>
                
                <div class="flex-grow"></div>

                <div>
                    <div class="progress-bar mb-2">
                        <div id="progress-${media.id}" class="progress-bar-inner" style="width: 0%;"></div>
                    </div>
                    <p id="status-${media.id}" class="status-message">Pronto.</p>
                    <div class="flex items-center space-x-2 mt-4">
                        <label for="file-input-${media.id}" class="file-input-label inline-block text-center flex-grow">Fazer Upload</label>
                        <input type="file" id="file-input-${media.id}" class="hidden" accept="${media.type}/*">
                        <button id="delete-btn-${media.id}" class="p-3 bg-red-100 text-red-700 rounded-md hover:bg-red-200 transition-colors" title="Excluir Mídia">
                            <i data-feather="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <label for="url-input-${media.id}" class="text-sm font-medium text-gray-700 mb-2 block">Ou cole uma URL:</label>
                    <div class="flex space-x-2">
                        <input type="url" id="url-input-${media.id}" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="https://...">
                        <button id="url-save-btn-${media.id}" class="px-4 py-2 bg-gray-700 text-white text-sm rounded-md hover:bg-gray-800 transition-colors">Salvar</button>
                    </div>
                </div>
            `;
            container.appendChild(card);
            feather.replace();
            
            // Event Listeners
            document.getElementById(`file-input-${media.id}`).addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) uploadMedia(media.id, file);
            });

            document.getElementById(`url-save-btn-${media.id}`).addEventListener('click', () => {
                const urlInput = document.getElementById(`url-input-${media.id}`);
                const newUrl = urlInput.value.trim();
                if (newUrl) {
                    saveUrl(media.id, newUrl);
                } else {
                    const statusEl = document.getElementById(`status-${media.id}`);
                    statusEl.textContent = 'Por favor, insira uma URL válida.';
                    statusEl.className = 'status-message status-error';
                }
            });

            document.getElementById(`delete-btn-${media.id}`).addEventListener('click', () => {
                showDeleteConfirm(media.id, media.title);
            });
        }
        
        async function saveUrl(id, url) {
            const statusEl = document.getElementById(`status-${id}`);
            statusEl.textContent = 'Salvando URL...';
            statusEl.className = 'status-message status-uploading';
            try {
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    throw new Error("URL inválida.");
                }
                await setDoc(contentDocRef, { [id]: url }, { merge: true });
                statusEl.textContent = 'Sucesso! URL atualizada.';
                statusEl.className = 'status-message status-success';
                updatePreview(id, url);
                document.getElementById(`url-input-${id}`).value = '';
            } catch (error) {
                statusEl.textContent = 'Erro ao salvar. Verifique a URL.';
                statusEl.className = 'status-message status-error';
            }
        }
        
        function updatePreview(mediaId, url) {
            const previewContainer = document.getElementById(`preview-container-${mediaId}`);
            const mediaType = mediaStructure.find(m => m.id === mediaId).type;
            if (url) {
                if (mediaType === 'video') {
                    previewContainer.innerHTML = `<video src="${url}" class="media-preview" controls muted loop playsinline></video>`;
                } else {
                    previewContainer.innerHTML = `<img src="${url}" alt="${mediaId}" class="media-preview">`;
                }
            } else {
                previewContainer.innerHTML = `<div class="media-preview flex items-center justify-center text-gray-500">Nenhuma mídia definida</div>`;
            }
        }

        async function loadCurrentMedia(mediaData) {
            mediaStructure.forEach(media => {
                updatePreview(media.id, mediaData[media.id]);
            });
        }
        
        function uploadMedia(id, file) {
            const statusEl = document.getElementById(`status-${id}`);
            const progressEl = document.getElementById(`progress-${id}`);
            const storageRef = ref(storage, `site-media/${id}-${Date.now()}-${file.name}`);
            const uploadTask = uploadBytesResumable(storageRef, file);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressEl.style.width = progress + '%';
                    statusEl.textContent = `Enviando... ${Math.round(progress)}%`;
                    statusEl.className = 'status-message status-uploading';
                }, 
                (error) => {
                    statusEl.textContent = 'Erro no envio.';
                    statusEl.className = 'status-message status-error';
                    progressEl.style.width = '0%';
                }, 
                () => {
                    getDownloadURL(uploadTask.snapshot.ref).then(async (downloadURL) => {
                        statusEl.textContent = 'Atualizando link...';
                        try {
                            await setDoc(contentDocRef, { [id]: downloadURL }, { merge: true });
                            statusEl.textContent = 'Sucesso! Mídia atualizada.';
                            statusEl.className = 'status-message status-success';
                            updatePreview(id, downloadURL);
                        } catch (dbError) {
                            statusEl.textContent = 'Erro ao salvar o link.';
                            statusEl.className = 'status-message status-error';
                        }
                    });
                }
            );
        }

        async function deleteMedia(id) {
            const statusEl = document.getElementById(`status-${id}`);
            statusEl.textContent = 'Excluindo...';
            statusEl.className = 'status-message status-uploading';
            try {
                // Opcional: Excluir o arquivo do Storage. Requer lógica mais complexa
                // para obter a URL do arquivo a partir do nome, se não estiver armazenada.
                // Por simplicidade, vamos apenas remover do Firestore.

                const fieldToDelete = { [id]: deleteField() };
                await updateDoc(contentDocRef, fieldToDelete);
                
                statusEl.textContent = 'Mídia excluída com sucesso.';
                statusEl.className = 'status-message status-success';
                updatePreview(id, null); // Limpa o preview
            } catch (error) {
                console.error("Erro ao excluir mídia:", error);
                statusEl.textContent = 'Erro ao excluir.';
                statusEl.className = 'status-message status-error';
            }
        }

        // --- Lógica do Modal de Confirmação ---
        const confirmModal = document.getElementById('confirm-modal');
        const confirmModalText = document.getElementById('confirm-modal-text');
        const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        let mediaIdToDelete = null;

        function showDeleteConfirm(id, title) {
            mediaIdToDelete = id;
            confirmModalText.textContent = `Tem certeza de que deseja excluir a mídia "${title}"? Esta ação não pode ser desfeita.`;
            confirmModal.classList.remove('hidden');
        }

        function hideDeleteConfirm() {
            mediaIdToDelete = null;
            confirmModal.classList.add('hidden');
        }

        confirmCancelBtn.addEventListener('click', hideDeleteConfirm);
        confirmDeleteBtn.addEventListener('click', () => {
            if (mediaIdToDelete) {
                deleteMedia(mediaIdToDelete);
            }
            hideDeleteConfirm();
        });


        // --- Função Principal de Inicialização ---
        async function initAdminPanel() {
            const sectionsContainer = document.getElementById('admin-sections');
            if (sectionsContainer.children.length > 0) return; // Já inicializado

            try {
                const docSnap = await getDoc(contentDocRef);
                const mediaData = docSnap.exists() ? docSnap.data() : {};

                const sections = mediaStructure.reduce((acc, media) => {
                    (acc[media.sectionTitle] = acc[media.sectionTitle] || []).push(media);
                    return acc;
                }, {});

                for (const sectionTitle in sections) {
                    const sectionItems = sections[sectionTitle];
                    
                    // Cria o container da seção
                    const sectionWrapper = document.createElement('div');
                    sectionWrapper.className = 'bg-white rounded-lg shadow-sm';
                    
                    // Cria o cabeçalho do accordion
                    const header = document.createElement('button');
                    header.className = 'accordion-header w-full p-5 flex justify-between items-center bg-gray-50 hover:bg-gray-100 rounded-lg';
                    header.innerHTML = `
                        <h2 class="text-xl font-semibold">${sectionTitle}</h2>
                        <i data-feather="chevron-down" class="accordion-icon"></i>
                    `;
                    
                    // Cria o conteúdo do accordion
                    const content = document.createElement('div');
                    content.className = 'accordion-content p-6 pt-0';
                    
                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';
                    content.appendChild(grid);
                    
                    sectionWrapper.appendChild(header);
                    sectionWrapper.appendChild(content);
                    sectionsContainer.appendChild(sectionWrapper);
                    
                    // Popula com os cards
                    sectionItems.forEach(media => createMediaCard(media, grid));

                    // Lógica do accordion
                    header.addEventListener('click', () => {
                        header.classList.toggle('active');
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    });
                }
                
                loadCurrentMedia(mediaData);
                feather.replace();

            } catch (error) {
                console.error("Erro ao inicializar o painel: ", error);
                sectionsContainer.innerHTML = `<p class="text-red-500">Não foi possível carregar os dados do site. Verifique o console para mais detalhes.</p>`;
            }
        }
    </script>
</body>
</html>
